services:
  db:
    image: yobasystems/alpine-mariadb:latest  # ARMv7-kompatibel
    container_name: nextcloud-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: MYSQL_ROOT_PASSWORD
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: MYSQL_PASSWORD
    volumes:
      - nextcloud-db:/var/lib/mysql
    networks:
      - nextcloud-net

  redis:
    image: redis:alpine
    container_name: nextcloud-redis
    restart: always
    volumes:
      - /home/axel/redis-data:/data
    command: ["redis-server", "--appendonly", "yes"]
    networks:
      - nextcloud-net

  app:
    image: nextcloud:apache
    container_name: nextcloud
    restart: always
    ports:
      - "8080:80"  # Zugriff Ã¼ber http://localhost:8080
      - "8443:443"  # HTTPS Port
    volumes:
      - nextcloud-data:/var/www/html
      - /mnt/vault/data/nextcloud:/var/www/html/data
      - ./nextcloud-certs:/etc/apache2/ssl
    environment:
      MYSQL_PASSWORD: MYSQL_PASSWORD
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_HOST: db
    depends_on:
      - db
      - redis
    networks:
      - nextcloud-net

  backup:
    image: alpine:latest
    container_name: nextcloud-backup
    depends_on:
      - db
      - app
    volumes:
      - /mnt/vault/data/nextcloud:/data:ro       # Nextcloud-Daten (read-only)
      - /mnt/vault/backup/nextcloud:/backup      # Backup-Ziel
      - ./backup.sh:/backup/backup.sh:ro         # Dein Script
      - nextcloud-data:/html:ro                  # Nextcloud Config
    environment:
      DB_HOST: db
      DB_NAME: nextcloud
      DB_USER: nextcloud
      DB_PASSWORD: ${MYSQL_PASSWORD}
    networks:
      - nextcloud-net
    entrypoint: ["/bin/sh", "-c"]
    command: |
      apk add --no-cache bash rsync mariadb-client curl &&
      chmod +x /backup/backup.sh &&
      /backup/backup.sh
volumes:
  nextcloud-data:
  nextcloud-db:

networks:
  nextcloud-net:
    driver: bridge
